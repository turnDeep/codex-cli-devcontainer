# Use Node.js 20 as base image
FROM mcr.microsoft.com/devcontainers/javascript-node:1-20-bookworm

# Install additional dependencies
RUN apt-get update && apt-get install -y \
    curl \
    wget \
    jq \
    python3 \
    python3-pip \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Switch to node user
USER node

# Set up workspace directory
WORKDIR /workspace

# Create necessary directories for Codex CLI
RUN mkdir -p /home/node/.codex \
    && mkdir -p /home/node/.codex/tmp \
    && mkdir -p /workspace/.codex

# Install Codex CLI globally and strip noisy legacy warnings
RUN npm install -g codex-cli \
    && sed -i '/Failed to load c++ bson extension/d' $(npm root -g)/codex-cli/node_modules/bson/ext/index.js

# Create a startup script
RUN echo '#!/bin/bash\n\
echo "ðŸš€ Codex CLI Development Container Ready!"\n\
echo "Run \"codex\" to get started."\n\
' > /home/node/codex-setup.sh && chmod +x /home/node/codex-setup.sh

# Set shell to zsh and suppress Node warnings from outdated dependencies
ENV NODE_NO_WARNINGS=1
SHELL ["/bin/zsh", "-c"]

# Expose ports for OAuth callbacks
EXPOSE 3000 3002 5000 8080

# Set the entrypoint
ENTRYPOINT ["/bin/zsh"]
